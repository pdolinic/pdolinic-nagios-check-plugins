
#!/bin/bash

##Description: Small Check for Educational Purposes 
##Author: pdolinic@netways.de, Junior Consultant at NETWAYS Professional Services GmbH. Deutschherrnstr. 15-19 90429 Nuremberg. 

#check_fileless_malware
#Literature: https://www.sandflysecurity.com/blog/detecting-linux-memfd-create-fileless-malware-with-command-line-forensics/

#License = GNU GPLv2

#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.

##This Script is not intended with security in mind, and currently does not implement any length or size checks: It depends on the security of the Icinga/Nagios-Account.
#  _____ _               _     ______ _ _      _                ___  ___      _                        
# /  __ \ |             | |    |  ___(_) |    | |               |  \/  |     | |                       
# | /  \/ |__   ___  ___| | __ | |_   _| | ___| | ___  ___ ___  | .  . | __ _| |_      ____ _ _ __ ___ 
# | |   | '_ \ / _ \/ __| |/ / |  _| | | |/ _ \ |/ _ \/ __/ __| | |\/| |/ _` | \ \ /\ / / _` | '__/ _ \
# | \__/\ | | |  __/ (__|   <  | |   | | |  __/ |  __/\__ \__ \ | |  | | (_| | |\ V  V / (_| | | |  __/
#  \____/_| |_|\___|\___|_|\_\ \_|   |_|_|\___|_|\___||___/___/ \_|  |_/\__,_|_| \_/\_/ \__,_|_|  \___|
#                          ______                           ______                                     
#                        |______|                         |______| 
#Exit Codes
#Exit_Codes=" >> 0:OK, 1:Warn, 2:Critical, 3:Unkown << "

#if [ -z "$1" ] || [ -z "$2" ] 
#then
#    echo ">> No arguments required << " && \
#fi
#

#Run Scan
check_fmw=$(ls -alR /proc/*/exe 2> /dev/null | grep memfd:.*\(deleted\))

#Check Matches
if [ "$?" -eq 1 ]
then
    echo "All good: No matches found"
    exit 0
fi
    if [ "$?" -eq 0 ]
then
   echo "Suspicious: Potentially malicious"
   exit 1
fi
